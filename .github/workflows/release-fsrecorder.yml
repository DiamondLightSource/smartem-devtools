name: FSRecorder Release

on:
  push:
    branches: [main]
    tags: ['fsrecorder-v*']
    paths:
      - 'packages/smartem-fsrecorder/**'
      - '.github/workflows/release-fsrecorder.yml'
  pull_request:
    paths:
      - 'packages/smartem-fsrecorder/**'
      - '.github/workflows/release-fsrecorder.yml'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'rc'
        type: choice
        options:
          - rc
          - stable

permissions:
  contents: read

env:
  PACKAGE_DIR: packages/smartem-fsrecorder

jobs:
  version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_stable: ${{ steps.version.outputs.is_stable }}
      is_rc: ${{ steps.version.outputs.is_rc }}
      should_release: ${{ steps.version.outputs.should_release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Determine version
        id: version
        run: |
          # Extract base version from pyproject.toml
          BASE_VERSION=$(grep -m1 'version = ' $PACKAGE_DIR/pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Base version: $BASE_VERSION"

          IS_STABLE="false"
          IS_RC="false"
          SHOULD_RELEASE="false"

          if [[ "$GITHUB_REF" == refs/tags/fsrecorder-v* ]]; then
            # Stable release from tag
            TAG_VERSION="${GITHUB_REF#refs/tags/fsrecorder-v}"
            if [[ "$TAG_VERSION" != "$BASE_VERSION" ]]; then
              echo "Error: Tag version ($TAG_VERSION) does not match pyproject.toml version ($BASE_VERSION)"
              exit 1
            fi
            VERSION="$BASE_VERSION"
            IS_STABLE="true"
            SHOULD_RELEASE="true"
          elif [[ "$GITHUB_REF" == refs/heads/main ]]; then
            # RC release on push to main
            VERSION="${BASE_VERSION}rc${{ github.run_number }}"
            IS_RC="true"
            SHOULD_RELEASE="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.release_type }}" == "stable" ]]; then
              VERSION="$BASE_VERSION"
              IS_STABLE="true"
              SHOULD_RELEASE="true"
            else
              VERSION="${BASE_VERSION}rc${{ github.run_number }}"
              IS_RC="true"
              SHOULD_RELEASE="true"
            fi
          else
            # PR or other - just use base version for testing
            VERSION="$BASE_VERSION"
            SHOULD_RELEASE="false"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_stable=$IS_STABLE" >> $GITHUB_OUTPUT
          echo "is_rc=$IS_RC" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Is stable: $IS_STABLE"
          echo "Is RC: $IS_RC"
          echo "Should release: $SHOULD_RELEASE"

  test-linux:
    name: Test (Linux)
    runs-on: ubuntu-latest
    needs: version
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest -v

  test-windows:
    name: Test (Windows)
    runs-on: windows-latest
    needs: version
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest -v

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: version
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

  build-wheel:
    name: Build Python package
    runs-on: ubuntu-latest
    needs: [test-linux, test-windows, lint]
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Update version for RC
        if: needs.version.outputs.is_rc == 'true'
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          sed -i "s/^__version__ = .*/__version__ = \"$VERSION\"/" smartem_fsrecorder/__init__.py
          echo "Updated version to $VERSION"
          cat pyproject.toml | grep version

      - name: Build package
        run: uv build

      - name: Check package metadata
        run: uvx twine check dist/*

      - name: List build artifacts
        run: ls -lh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: python-dist
          path: ${{ env.PACKAGE_DIR }}/dist/*
          retention-days: 7

  build-windows:
    name: Build Windows executable
    runs-on: windows-latest
    needs: [test-linux, test-windows, lint, version]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install ${{ env.PACKAGE_DIR }}

      - name: Build with PyInstaller
        run: >-
          pyinstaller --onefile
          --name fsrecorder
          --hidden-import watchdog.observers.polling
          --hidden-import watchdog.observers.winapi
          --hidden-import watchdog.observers.inotify
          --hidden-import watchdog.observers.fsevents
          --hidden-import watchdog.observers.kqueue
          ${{ env.PACKAGE_DIR }}/smartem_fsrecorder/cli.py

      - name: Rename executable with version
        run: |
          $VERSION = "${{ needs.version.outputs.version }}"
          Move-Item dist/fsrecorder.exe "dist/fsrecorder-windows-v${VERSION}.exe"

      - name: Upload Windows executable
        uses: actions/upload-artifact@v6
        with:
          name: windows-exe
          path: dist/fsrecorder-windows-v*.exe
          retention-days: 7

  smoke-test-windows:
    name: Smoke test Windows executable
    runs-on: windows-latest
    needs: [build-windows, version]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download Windows executable
        uses: actions/download-artifact@v7
        with:
          name: windows-exe
          path: dist/

      - name: Smoke test - help
        run: |
          $VERSION = "${{ needs.version.outputs.version }}"
          $EXE = "dist/fsrecorder-windows-v${VERSION}.exe"
          & $EXE --help
          if ($LASTEXITCODE -ne 0) { throw "Help command failed" }

      - name: Smoke test - record (create small recording)
        run: |
          $VERSION = "${{ needs.version.outputs.version }}"
          $EXE = "dist/fsrecorder-windows-v${VERSION}.exe"

          # Create a test directory with some files
          New-Item -ItemType Directory -Path "test_watch" -Force
          Set-Content -Path "test_watch/test.txt" -Value "Hello, World!"
          New-Item -ItemType Directory -Path "test_watch/subdir" -Force
          Set-Content -Path "test_watch/subdir/nested.txt" -Value "Nested content"

          # Start recording in background and stop after 2 seconds
          $job = Start-Job -ScriptBlock {
            param($exe)
            & $exe record test_watch -o recording.tar.gz
          } -ArgumentList (Resolve-Path $EXE)

          Start-Sleep -Seconds 2
          Stop-Job $job -PassThru | Remove-Job

          # Verify recording was created (may not exist if stopped too quickly)
          # This is a best-effort test
          Write-Host "Record smoke test completed"

      - name: Smoke test - info
        run: |
          $VERSION = "${{ needs.version.outputs.version }}"
          $EXE = "dist/fsrecorder-windows-v${VERSION}.exe"

          # Create a minimal recording for info test
          New-Item -ItemType Directory -Path "info_test" -Force
          Set-Content -Path "info_test/test.txt" -Value "Test"

          # Create a quick recording
          $job = Start-Job -ScriptBlock {
            param($exe)
            & $exe record info_test -o info_recording.tar.gz
          } -ArgumentList (Resolve-Path $EXE)

          Start-Sleep -Seconds 2
          Stop-Job $job -PassThru | Remove-Job

          # If recording exists, test info command
          if (Test-Path "info_recording.tar.gz") {
            & $EXE info info_recording.tar.gz
            if ($LASTEXITCODE -ne 0) { throw "Info command failed" }
          } else {
            Write-Host "Recording not created in time, skipping info test"
          }

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-wheel, smoke-test-windows, version]
    if: needs.version.outputs.is_stable == 'true'
    environment:
      name: pypi
      url: https://pypi.org/p/smartem-fsrecorder
    permissions:
      id-token: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: python-dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-wheel, build-windows, smoke-test-windows, version]
    if: needs.version.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Python dist
        uses: actions/download-artifact@v7
        with:
          name: python-dist
          path: dist/

      - name: Download Windows executable
        uses: actions/download-artifact@v7
        with:
          name: windows-exe
          path: dist/

      - name: List all artifacts
        run: ls -la dist/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          IS_STABLE="${{ needs.version.outputs.is_stable }}"
          IS_RC="${{ needs.version.outputs.is_rc }}"

          # Get previous tag for changelog
          if [[ "$IS_STABLE" == "true" ]]; then
            PREV_TAG=$(git tag -l 'fsrecorder-v*' | grep -v "$VERSION" | sort -V | tail -1 || echo "")
          else
            PREV_TAG=$(git tag -l 'fsrecorder-v*' | sort -V | tail -1 || echo "")
          fi

          echo "Previous tag: $PREV_TAG"

          # Generate changelog
          {
            if [[ "$IS_RC" == "true" ]]; then
              echo "## FSRecorder v$VERSION (Release Candidate)"
              echo ""
              echo "> This is a pre-release for testing. For production use, please use the latest stable release."
              echo ""
            else
              echo "## FSRecorder v$VERSION"
              echo ""
            fi

            echo "### Installation"
            echo ""
            echo "**Python package:**"
            echo "\`\`\`bash"
            if [[ "$IS_STABLE" == "true" ]]; then
              echo "pip install smartem-fsrecorder"
            else
              echo "# RC releases are only available from GitHub"
              echo "pip install dist/smartem_fsrecorder-*.whl"
            fi
            echo "\`\`\`"
            echo ""
            echo "**Windows executable:**"
            echo "Download \`fsrecorder-windows-v$VERSION.exe\` from the assets below."
            echo ""

            if [[ -n "$PREV_TAG" ]]; then
              echo "### Changes since $PREV_TAG"
              echo ""

              # Get PRs with component:fsrecorder label
              gh pr list \
                --state merged \
                --label "component:fsrecorder" \
                --search "merged:>=$(git log -1 --format=%ci $PREV_TAG 2>/dev/null | cut -d' ' -f1 || echo '2024-01-01')" \
                --json number,title,author \
                --jq '.[] | "- #\(.number) \(.title) (@\(.author.login))"' 2>/dev/null || true

              echo ""

              # Fallback: commits to the package directory
              echo "### Commits"
              echo ""
              git log ${PREV_TAG}..HEAD --oneline -- packages/smartem-fsrecorder/ | head -20 || echo "No commits found"
            fi
          } > release_notes.md

          echo "Release notes:"
          cat release_notes.md

          # Set output (escape for GitHub Actions)
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ needs.version.outputs.is_stable == 'true' && format('fsrecorder-v{0}', needs.version.outputs.version) || format('fsrecorder-v{0}', needs.version.outputs.version) }}
          name: FSRecorder v${{ needs.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          prerelease: ${{ needs.version.outputs.is_rc == 'true' }}
          files: dist/*
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
