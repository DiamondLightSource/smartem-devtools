name: Release smartem-workspace

on:
  push:
    branches: [main]
    tags: ['smartem-workspace-v*']
    paths:
      - 'packages/smartem-workspace/**'
      - '.github/workflows/release-smartem-workspace.yml'
  pull_request:
    paths:
      - 'packages/smartem-workspace/**'
      - '.github/workflows/release-smartem-workspace.yml'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'rc'
        type: choice
        options:
          - rc
          - stable

permissions:
  contents: read

env:
  PACKAGE_DIR: packages/smartem-workspace

jobs:
  version:
    name: Determine version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_stable: ${{ steps.version.outputs.is_stable }}
      is_rc: ${{ steps.version.outputs.is_rc }}
      should_release: ${{ steps.version.outputs.should_release }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          # Extract base version from pyproject.toml
          BASE_VERSION=$(grep -m1 'version = ' $PACKAGE_DIR/pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Base version: $BASE_VERSION"

          # Validate version matches __init__.py
          INIT_VERSION=$(grep -m1 '__version__ = ' $PACKAGE_DIR/smartem_workspace/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
          echo "Init version: $INIT_VERSION"

          if [[ "$BASE_VERSION" != "$INIT_VERSION" ]]; then
            echo "::error::Version mismatch! pyproject.toml=$BASE_VERSION, __init__.py=$INIT_VERSION"
            exit 1
          fi
          echo "Version validation passed: $BASE_VERSION"

          IS_STABLE="false"
          IS_RC="false"
          SHOULD_RELEASE="false"

          if [[ "$GITHUB_REF" == refs/tags/smartem-workspace-v* ]]; then
            # Stable release from tag
            TAG_VERSION="${GITHUB_REF#refs/tags/smartem-workspace-v}"
            if [[ "$TAG_VERSION" != "$BASE_VERSION" ]]; then
              echo "Error: Tag version ($TAG_VERSION) does not match pyproject.toml version ($BASE_VERSION)"
              exit 1
            fi
            VERSION="$BASE_VERSION"
            IS_STABLE="true"
            SHOULD_RELEASE="true"
          elif [[ "$GITHUB_REF" == refs/heads/main ]]; then
            # Check if stable tag already exists for this version
            STABLE_TAG="smartem-workspace-v${BASE_VERSION}"
            if git tag -l "$STABLE_TAG" | grep -q "$STABLE_TAG"; then
              echo "Stable tag $STABLE_TAG already exists. Skipping RC release."
              VERSION="$BASE_VERSION"
              IS_RC="false"
              IS_STABLE="false"
              SHOULD_RELEASE="false"
            else
              # RC release on push to main
              VERSION="${BASE_VERSION}rc${{ github.run_number }}"
              IS_RC="true"
              SHOULD_RELEASE="true"
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ inputs.release_type }}" == "stable" ]]; then
              VERSION="$BASE_VERSION"
              IS_STABLE="true"
              SHOULD_RELEASE="true"
            else
              VERSION="${BASE_VERSION}rc${{ github.run_number }}"
              IS_RC="true"
              SHOULD_RELEASE="true"
            fi
          else
            # PR or other - just use base version for testing
            VERSION="$BASE_VERSION"
            SHOULD_RELEASE="false"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_stable=$IS_STABLE" >> $GITHUB_OUTPUT
          echo "is_rc=$IS_RC" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT

          echo "Version: $VERSION"
          echo "Is stable: $IS_STABLE"
          echo "Is RC: $IS_RC"
          echo "Should release: $SHOULD_RELEASE"

  test:
    name: Test smartem-workspace
    runs-on: ubuntu-latest
    needs: version
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest -v

  lint:
    name: Lint smartem-workspace
    runs-on: ubuntu-latest
    needs: version
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

  build:
    name: Build smartem-workspace package
    runs-on: ubuntu-latest
    needs: [test, lint, version]
    if: github.event.pull_request.draft == false || github.event_name != 'pull_request'
    defaults:
      run:
        working-directory: ${{ env.PACKAGE_DIR }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.11

      - name: Update version for RC
        if: needs.version.outputs.is_rc == 'true'
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          sed -i "s/^__version__ = .*/__version__ = \"$VERSION\"/" smartem_workspace/__init__.py
          echo "Updated version to $VERSION"
          cat pyproject.toml | grep version

      - name: Build package
        run: uv build

      - name: Check package metadata
        run: uvx twine check dist/*

      - name: List build artifacts
        run: ls -lh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: ${{ env.PACKAGE_DIR }}/dist/*
          retention-days: 7

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build, version]
    if: needs.version.outputs.is_stable == 'true'
    environment:
      name: pypi
      url: https://pypi.org/p/smartem-workspace
    permissions:
      id-token: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, version]
    if: needs.version.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download dist artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist
          path: dist/

      - name: List all artifacts
        run: ls -la dist/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          IS_STABLE="${{ needs.version.outputs.is_stable }}"
          IS_RC="${{ needs.version.outputs.is_rc }}"

          # Get previous tag for changelog
          if [[ "$IS_STABLE" == "true" ]]; then
            PREV_TAG=$(git tag -l 'smartem-workspace-v*' | grep -v "$VERSION" | sort -V | tail -1 || echo "")
          else
            PREV_TAG=$(git tag -l 'smartem-workspace-v*' | sort -V | tail -1 || echo "")
          fi

          echo "Previous tag: $PREV_TAG"

          # Generate changelog
          {
            if [[ "$IS_RC" == "true" ]]; then
              echo "## smartem-workspace v$VERSION (Release Candidate)"
              echo ""
              echo "> This is a pre-release for testing. For production use, please use the latest stable release."
              echo ""
            else
              echo "## smartem-workspace v$VERSION"
              echo ""
            fi

            echo "### Installation"
            echo ""
            echo "**Python package:**"
            echo "\`\`\`bash"
            if [[ "$IS_STABLE" == "true" ]]; then
              echo "pip install smartem-workspace"
              echo "# or with uvx"
              echo "uvx smartem-workspace --help"
            else
              echo "# RC releases are only available from GitHub"
              echo "pip install dist/smartem_workspace-*.whl"
            fi
            echo "\`\`\`"
            echo ""

            if [[ -n "$PREV_TAG" ]]; then
              echo "### Changes since $PREV_TAG"
              echo ""

              # Get PRs with component:smartem-workspace label
              gh pr list \
                --state merged \
                --label "component:smartem-workspace" \
                --search "merged:>=$(git log -1 --format=%ci $PREV_TAG 2>/dev/null | cut -d' ' -f1 || echo '2024-01-01')" \
                --json number,title,author \
                --jq '.[] | "- #\(.number) \(.title) (@\(.author.login))"' 2>/dev/null || true

              echo ""

              # Fallback: commits to the package directory
              echo "### Commits"
              echo ""
              git log ${PREV_TAG}..HEAD --oneline -- packages/smartem-workspace/ | head -20 || echo "No commits found"
            fi
          } > release_notes.md

          echo "Release notes:"
          cat release_notes.md

          # Set output (escape for GitHub Actions)
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: ${{ needs.version.outputs.is_stable == 'true' && format('smartem-workspace-v{0}', needs.version.outputs.version) || format('smartem-workspace-v{0}', needs.version.outputs.version) }}
          name: smartem-workspace v${{ needs.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          prerelease: ${{ needs.version.outputs.is_rc == 'true' }}
          files: dist/*
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
